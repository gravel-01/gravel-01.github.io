import React, { useState, useEffect } from 'react';
import { 
  Zap, FileBox, BrainCircuit, Settings2, Code2, Copy, CheckCircle2, 
  Image as ImageIcon, Maximize, SunMedium, Grid, MonitorOff, BookOpen,
  Info, Activity, AlertTriangle, ArrowRight, Layers, FileCode2, Terminal
} from 'lucide-react';

// --- æ•°æ®å®šä¹‰ ---
const MODELS = {
  ocr_v5: {
    id: 'PP-OCRv5',
    name: 'PP-OCRv5',
    tag: 'è½»é‡æé€Ÿ',
    icon: <Zap className="w-6 h-6 text-amber-500" />,
    bg: 'from-amber-50 to-orange-50/50',
    border: 'border-amber-200/50',
    desc: 'ä¸è¶³1äº¿å‚æ•°çš„è½»é‡çº§åŸºç¡€OCRã€‚',
    features: ['æ¯«ç§’çº§æé€Ÿå“åº”', 'æ”¯æŒæé«˜å¹¶å‘ (QPS)', 'APIè°ƒç”¨æˆæœ¬å…¨åœºæœ€ä½'],
    useCases: 'æµ·é‡å†å²æ¸…æ™°æ•°æ®å½’æ¡£ã€ç§»åŠ¨ç«¯/è¾¹ç¼˜ç«¯å®æ—¶æ‰«ç ã€è½¦ç‰Œè¯†åˆ«ç­‰çº¯æ–‡æœ¬â€œèµ°é‡â€ä¸šåŠ¡ã€‚',
  },
  structure_v3: {
    id: 'PP-StructureV3',
    name: 'PP-StructureV3',
    tag: 'ç»“æ„è¿˜åŸ',
    icon: <FileBox className="w-6 h-6 text-blue-500" />,
    bg: 'from-blue-50 to-indigo-50/50',
    border: 'border-blue-200/50',
    desc: 'è½»é‡çº§å±‚çº§åŒ–æ–‡æ¡£è§£æå·¥å…·ã€‚',
    features: ['ä½å»¶è¿Ÿã€ä½æˆæœ¬', 'æé«˜æ€§ä»·æ¯”è¿˜åŸæ®µè½é€»è¾‘', 'æ ‡å‡†è¡¨æ ¼ç»“æ„è¿˜åŸ'],
    useCases: 'æ’ç‰ˆè§„èŒƒçš„æ•°å­—åŸç”ŸPDFè§£æã€é«˜è´¨é‡åˆåŒ/ç ”æŠ¥æ‰«æä»¶çš„ç»“æ„åŒ–æå–ã€‚',
  },
  vl_1_5: {
    id: 'PaddleOCR-VL-1.5',
    name: 'PaddleOCR-VL-1.5',
    tag: 'å…¨èƒ½æ——èˆ°',
    icon: <BrainCircuit className="w-6 h-6 text-purple-500" />,
    bg: 'from-purple-50 to-fuchsia-50/50',
    border: 'border-purple-200/50',
    desc: '0.9Bå‚æ•°çš„å¤šä»»åŠ¡è§†è§‰è¯­è¨€æ¨¡å‹ (VLM)ã€‚',
    features: ['SOTAçº§è¶…é«˜ç²¾åº¦ (94.5%)', 'æŠ—æ¶åŠ£å¹²æ‰°èƒ½åŠ›æå¼º', 'ä¸€æ­¥è¾“å‡ºé«˜ä¿çœŸ Markdown'],
    useCases: 'ç”¨æˆ·éšæ‰‹æ‹çš„ç•¸å˜ç…§ç‰‡ã€ç§‘ç ”æ–‡çŒ®é«˜ä¿çœŸè¿˜åŸã€å¤§æ¨¡å‹RAGé«˜è´¨é‡çŸ¥è¯†åº“æ„å»ºã€‚',
  }
};

export default function App() {
  const [activeTab, setActiveTab] = useState('generator'); // é»˜è®¤å±•ç¤ºåŠŸèƒ½é¡µ
  const [activeCodeTab, setActiveCodeTab] = useState('workflow'); // é»˜è®¤å±•ç¤ºæ€»å·¥ä½œæµ
  const [copied, setCopied] = useState(false);

  // å®˜æ–¹ç‹¬ç«‹ Demo é…ç½®çŠ¶æ€
  const [officialDemoModel, setOfficialDemoModel] = useState('PP-OCRv5');
  const [officialDemoMode, setOfficialDemoMode] = useState('sync');
  const [copiedOfficial, setCopiedOfficial] = useState(false);

  // ä»£ç ç”Ÿæˆå™¨é…ç½®çŠ¶æ€
  const [config, setConfig] = useState({
    model: 'PaddleOCR-VL-1.5',
    apiMode: 'sync',
    enableResize: true,
    maxSize: 1920,
    enableDeskew: true,
    enableClahe: true,
    enableMoire: false,
    enableDpi: true,
    targetDpi: 100,
  });

  const handleCopy = (text) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  // ---- åŠ¨æ€ç»„è£…å®˜æ–¹ API Code (æå–ä¸ºç‹¬ç«‹å‡½æ•°) ----
  const getOfficialDemoCode = (modelId, mode) => {
    const isOcrV5 = modelId === 'PP-OCRv5';
    const resultsKey = isOcrV5 ? 'ocrResults' : 'layoutParsingResults';

    if (mode === 'sync') {
      return `import base64
import requests
import os

API_URL = "https://your-api-url.com/layout-parsing"
TOKEN = "your_personal_token_here"
OUTPUT_DIR = "output"

def call_paddleocr_sync(file_path):
    print(f"\\næ­£åœ¨è°ƒç”¨äº‘ç«¯åŒæ­¥ API: {file_path}")
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    with open(file_path, "rb") as file:
        file_bytes = file.read()
        file_data = base64.b64encode(file_bytes).decode("ascii")

    headers = {
        "Authorization": f"token {TOKEN}",
        "Content-Type": "application/json"
    }
    
    required_payload = {
        "file": file_data,
        "fileType": 1, # 1ä¸ºå›¾ç‰‡, 0ä¸ºPDF
    }
    
    optional_payload = {
        "useDocOrientationClassify": False,
        "useDocUnwarping": False,
        ${!isOcrV5 ? '"useChartRecognition": False,' : '"useTextlineOrientation": False,'}
    }
    
    payload = {**required_payload, **optional_payload}

    response = requests.post(API_URL, json=payload, headers=headers)
    response.raise_for_status()
    result = response.json().get("result", {})
    
${isOcrV5 ? `    # è§£æ PP-OCRv5 ç»“æœ
    if "${resultsKey}" in result:
        for i, res in enumerate(result["${resultsKey}"]):
            print(res.get("prunedResult", ""))
            
            # ä¸‹è½½è£å‰ªå›¾
            image_url = res.get("ocrImage")
            if image_url:
                img_response = requests.get(image_url)
                if img_response.status_code == 200:
                    filename = os.path.join(OUTPUT_DIR, f"output_{i}.jpg")
                    with open(filename, "wb") as f:
                        f.write(img_response.content)
                    print(f"Image saved to: {filename}")` : `    # è§£æç‰ˆé¢åˆ†æç»“æœå¹¶ä¸‹è½½èµ„æº
    if "${resultsKey}" in result:
        for i, res in enumerate(result["${resultsKey}"]):
            # ä¿å­˜ Markdown
            md_filename = os.path.join(OUTPUT_DIR, f"doc_{i}.md")
            with open(md_filename, "w", encoding="utf-8") as md_file:
                md_file.write(res.get("markdown", {}).get("text", ""))
            print(f"Markdown document saved at {md_filename}")
            
            # ä¸‹è½½æ’å›¾/å…¬å¼åˆ‡ç‰‡
            for img_path, img_url in res.get("markdown", {}).get("images", {}).items():
                full_img_path = os.path.join(OUTPUT_DIR, img_path)
                os.makedirs(os.path.dirname(full_img_path), exist_ok=True)
                img_bytes = requests.get(img_url).content
                with open(full_img_path, "wb") as img_file:
                    img_file.write(img_bytes)
                print(f"Image saved to: {full_img_path}")
                
            # ä¸‹è½½æ ‡è®°å›¾
            for img_name, img_url in res.get("outputImages", {}).items():
                img_response = requests.get(img_url)
                if img_response.status_code == 200:
                    filename = os.path.join(OUTPUT_DIR, f"{img_name}_{i}.jpg")
                    with open(filename, "wb") as f:
                        f.write(img_response.content)
                    print(f"Image saved to: {filename}")`}
    return result

if __name__ == "__main__":
    test_file = "test_image.jpg" # æ›¿æ¢ä¸ºä½ çš„æœ¬åœ°å›¾ç‰‡è·¯å¾„
    if os.path.exists(test_file):
        call_paddleocr_sync(test_file)
    else:
        print(f"æ‰¾ä¸åˆ°æµ‹è¯•æ–‡ä»¶: {test_file}")`;
    } else {
      return `import requests
import os
import time
import json
import sys

JOB_URL = "https://paddleocr.aistudio-app.com/api/v2/ocr/jobs"
TOKEN = "your_personal_token_here"
MODEL = "${modelId}"
OUTPUT_DIR = "output"

def call_paddleocr_async(file_path):
    print(f"\\nProcessing file: {file_path}")
    headers = { "Authorization": f"bearer {TOKEN}" }
    
    optional_payload = {
        "useDocOrientationClassify": False,
        "useDocUnwarping": False,
        ${!isOcrV5 ? '"useChartRecognition": False,' : '"useTextlineOrientation": False,'}
    }
    
    data = {
        "model": MODEL,
        "optionalPayload": json.dumps(optional_payload)
    }
    
    with open(file_path, "rb") as f:
        files = {"file": f}
        job_response = requests.post(JOB_URL, headers=headers, data=data, files=files)
    
    if job_response.status_code != 200:
        print(f"Response content: {job_response.text}")
        sys.exit(1)
        
    jobId = job_response.json()["data"]["jobId"]
    print(f"Job submitted successfully. job id: {jobId}\\nStart polling for results")

    jsonl_url = ""
    while True:
        job_result_response = requests.get(f"{JOB_URL}/{jobId}", headers=headers)
        if job_result_response.status_code != 200:
            time.sleep(5)
            continue
            
        state = job_result_response.json()["data"]["state"]
        if state == 'pending':
            print("The current status of the job is pending")
        elif state == 'running':
            try:
                progress = job_result_response.json()['data']['extractProgress']
                print(f"Job running, total pages: {progress.get('totalPages')}, extracted: {progress.get('extractedPages')}")
            except KeyError:
                print("The current status of the job is running...")
        elif state == 'done':
            progress = job_result_response.json()['data'].get('extractProgress', {})
            print(f"Job completed, extracted pages: {progress.get('extractedPages')}")
            jsonl_url = job_result_response.json()['data']['resultUrl']['jsonUrl']
            break
        elif state == "failed":
            error_msg = job_result_response.json()['data']['errorMsg']
            print(f"Job failed, failure reason: {error_msg}")
            sys.exit()
            
        time.sleep(5)
        
    # ä¸‹è½½å¹¶è§£æ jsonl ç»“æœ
    if jsonl_url:
        print("Downloading and parsing results...")
        jsonl_response = requests.get(jsonl_url)
        jsonl_response.raise_for_status()
        lines = jsonl_response.text.strip().split('\\n')
        
        os.makedirs(OUTPUT_DIR, exist_ok=True)
        page_num = 0
        
        for line in lines:
            line = line.strip()
            if not line: continue
            
            result = json.loads(line).get("result", {})
${isOcrV5 ? `            if "${resultsKey}" in result:
                for i, res in enumerate(result["${resultsKey}"]):
                    image_url = res.get("ocrImage")
                    if image_url:
                        img_response = requests.get(image_url)
                        if img_response.status_code == 200:
                            filename = os.path.join(OUTPUT_DIR, f"img_output_{page_num}.jpg")
                            with open(filename, "wb") as f:
                                f.write(img_response.content)
                            print(f"Image saved to: {filename}")` : `            if "${resultsKey}" in result:
                for i, res in enumerate(result["${resultsKey}"]):
                    # ä¿å­˜ Markdown
                    md_filename = os.path.join(OUTPUT_DIR, f"doc_{page_num}.md")
                    with open(md_filename, "w", encoding="utf-8") as md_file:
                        md_file.write(res.get("markdown", {}).get("text", ""))
                    print(f"Markdown document saved at {md_filename}")
                    
                    # ä¸‹è½½æ’å›¾
                    for img_path, img_url in res.get("markdown", {}).get("images", {}).items():
                        full_img_path = os.path.join(OUTPUT_DIR, img_path)
                        os.makedirs(os.path.dirname(full_img_path), exist_ok=True)
                        img_bytes = requests.get(img_url).content
                        with open(full_img_path, "wb") as img_file:
                            img_file.write(img_bytes)
                            
                    # ä¸‹è½½æ ‡è®°å›¾
                    for img_name, img_url in res.get("outputImages", {}).items():
                        img_response = requests.get(img_url)
                        if img_response.status_code == 200:
                            filename = os.path.join(OUTPUT_DIR, f"{img_name}_{page_num}.jpg")
                            with open(filename, "wb") as f:
                                f.write(img_response.content)`}
            page_num += 1
        print("All results parsed and saved!")

if __name__ == "__main__":
    test_file = "test_image.jpg" # æ›¿æ¢ä¸ºä½ çš„æœ¬åœ°å›¾ç‰‡è·¯å¾„
    if os.path.exists(test_file):
        call_paddleocr_async(test_file)
    else:
        print(f"æ‰¾ä¸åˆ°æµ‹è¯•æ–‡ä»¶: {test_file}")`;
    }
  };

  // ---- ä»£ç å—ç”Ÿæˆé€»è¾‘ ----
  const codeBlocks = {
    dpi: `from PIL import Image
import cv2
import numpy as np

def get_image_dpi(file_path):
    """è¯»å–å›¾åƒæ–‡ä»¶çš„ DPI å…ƒæ•°æ®æ ‡ç­¾"""
    try:
        with Image.open(file_path) as img:
            dpi = img.info.get('dpi')
            if dpi:
                return f"{int(dpi[0])} x {int(dpi[1])}"
            return "æœªè®¾ç½®(ç³»ç»Ÿé»˜è®¤)"
    except Exception as e:
        return f"è¯»å–å¤±è´¥:{e}"

def resample_image_by_dpi(image_path, target_dpi=${config.targetDpi}, default_original_dpi=72):
    """çœŸæ­£çš„ DPI è½¬æ¢å™¨:ä¸ä»…ä¿®æ”¹æ ‡ç­¾,è¿˜ä¼šç‰©ç†ç¼©æ”¾åƒç´ çŸ©é˜µã€‚"""
    with Image.open(image_path) as img:
        orig_dpi_tuple = img.info.get('dpi')
        original_dpi = orig_dpi_tuple[0] if orig_dpi_tuple else default_original_dpi
        
        scale_factor = target_dpi / original_dpi
        if scale_factor == 1.0:
            print(f" åŸå›¾å·²ç»æ˜¯ {target_dpi} DPI,è·³è¿‡é‡é‡‡æ ·ã€‚")
            return cv2.cvtColor(np.array(img), cv2.COLOR_RGB2BGR)
            
        new_width = int(img.width * scale_factor)
        new_height = int(img.height * scale_factor)
        print(f" [ç‰©ç†DPIé‡é‡‡æ ·]: {original_dpi} -> {target_dpi} DPI")
        resized_img = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
        return cv2.cvtColor(np.array(resized_img), cv2.COLOR_RGB2BGR)`,

    resize: `import cv2

def resize_image_for_paddle(image, max_side_len=${config.maxSize}):
    """é™åˆ¶å›¾åƒçš„æœ€å¤§è¾¹é•¿,é˜²æ­¢è¿‡å¤§åˆ†è¾¨ç‡å¯¼è‡´ Token çˆ†ç‚¸åŠæ¨¡å‹å¹»è§‰ã€‚"""
    h, w = image.shape[:2]
    if max(h, w) > max_side_len:
        if h > w:
            new_h = max_side_len
            new_w = int(w * (max_side_len / h))
        else:
            new_w = max_side_len
            new_h = int(h * (max_side_len / w))
        print(f" [æé™å°ºå¯¸æˆªæ–­]: ({w}x{h}) -> ({new_w}x{new_h})")
        return cv2.resize(image, (new_w, new_h), interpolation=cv2.INTER_AREA)
    return image`,

    deskew: `import cv2
import numpy as np

def deskew_image(image):
    """åˆ©ç”¨ Canny è¾¹ç¼˜æ£€æµ‹å’Œéœå¤«å˜æ¢å¯¹å›¾åƒè¿›è¡Œè½»é‡çº§å€¾æ–œæ ¡æ­£ã€‚"""
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    edges = cv2.Canny(gray, 50, 150, apertureSize=3)
    lines = cv2.HoughLinesP(edges, 1, np.pi / 180, 100, minLineLength=100, maxLineGap=10)
    
    if lines is not None:
        angles = []
        for line in lines:
            x1, y1, x2, y2 = line[0]
            angle = np.degrees(np.arctan2(y2 - y1, x2 - x1))
            if -45 < angle < 45:
                angles.append(angle)
        
        if angles:
            median_angle = np.median(angles)
            if abs(median_angle) > 0.5:
                h, w = image.shape[:2]
                center = (w // 2, h // 2)
                M = cv2.getRotationMatrix2D(center, median_angle, 1.0)
                rotated = cv2.warpAffine(image, M, (w, h), flags=cv2.INTER_CUBIC, 
                                         borderMode=cv2.BORDER_CONSTANT, borderValue=(255, 255, 255))
                print(f" [å€¾æ–œæ ¡æ­£]:æ—‹è½¬äº† {median_angle:.2f}åº¦")
                return rotated
    print(" [å€¾æ–œæ ¡æ­£]:æœªæ£€æµ‹åˆ°æ˜æ˜¾å€¾æ–œ")
    return image`,

    clahe: `import cv2

def enhance_contrast_clahe(image):
    """ä½¿ç”¨ CLAHE å¢å¼ºå›¾åƒå±€éƒ¨å¯¹æ¯”åº¦,æ‹¯æ•‘é˜´å½±æ–‡æœ¬ã€‚"""
    lab = cv2.cvtColor(image, cv2.COLOR_BGR2LAB)
    l, a, b = cv2.split(lab)
    clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
    cl = clahe.apply(l)
    limg = cv2.merge((cl, a, b))
    print("[å…‰ç…§å¢å¼º]: CLAHE å¯¹æ¯”åº¦æå‡å®Œæˆ")
    return cv2.cvtColor(limg, cv2.COLOR_LAB2BGR)`,

    moire: `import cv2

def remove_moire_pattern(image):
    """ä½¿ç”¨ 3x3 é«˜æ–¯æ ¸å¯¹ä»˜å±å¹•ç¿»æ‹é€ æˆçš„æ‘©å°”çº¹ã€‚"""
    print(" [é™å™ªå¤„ç†]:å·²åº”ç”¨ 3x3 é«˜æ–¯æ¨¡ç³Š,å¼±åŒ–å±å¹•æ‘©å°”çº¹")
    return cv2.GaussianBlur(image, (3, 3), 0)`
  };

  // ç”Ÿæˆæœ€ç»ˆçš„æ€»å·¥ä½œæµä»£ç 
  const generateWorkflowCode = () => {
    let code = `import base64
import os
import sys
import requests
import time
import json
import cv2
import numpy as np
from PIL import Image

# ==========================================
# å…¨å±€é…ç½®å‚æ•°
# ==========================================
API_URL = "https://your-api-url.com/layout-parsing"
JOB_URL = "https://paddleocr.aistudio-app.com/api/v2/ocr/jobs"
TOKEN = "your_personal_token_here"
PROCESSED_DIR = "processed_images"
OUTPUT_DIR = "output"
MODEL = "${config.model}"

# ==========================================
# æ ¸å¿ƒé¢„å¤„ç†ç®—æ³•æ¨¡å—é›†æˆ
# ==========================================
`;
    // æ³¨å…¥é€‰ä¸­çš„æ¨¡å—ä»£ç ï¼ˆå»æ‰é‡å¤çš„ importï¼‰
    if (config.enableDpi) code += codeBlocks.dpi.replace(/import .*\n/g, '').replace(/from .*\n/g, '') + '\n';
    if (config.enableResize) code += codeBlocks.resize.replace(/import .*\n/g, '').replace(/from .*\n/g, '') + '\n';
    if (config.enableDeskew) code += codeBlocks.deskew.replace(/import .*\n/g, '').replace(/from .*\n/g, '') + '\n';
    if (config.enableClahe) code += codeBlocks.clahe.replace(/import .*\n/g, '').replace(/from .*\n/g, '') + '\n';
    if (config.enableMoire) code += codeBlocks.moire.replace(/import .*\n/g, '').replace(/from .*\n/g, '') + '\n';

    const isOcrV5Wf = config.model === 'PP-OCRv5';
    const resultsKeyWf = isOcrV5Wf ? 'ocrResults' : 'layoutParsingResults';

    code += `
# ==========================================
# é¢„å¤„ç†è°ƒåº¦å™¨ (Pipeline)
# ==========================================
def preprocess_image(input_path):
    """æ‰§è¡Œå®Œæ•´çš„å›¾åƒé¢„å¤„ç†ç«¯åˆ°ç«¯æµæ°´çº¿"""
    os.makedirs(PROCESSED_DIR, exist_ok=True)
    base_name = os.path.basename(input_path)
    output_path = os.path.join(PROCESSED_DIR, f"enhanced_{base_name}")
    
    print(f"\\n[Pipeline] å¼€å§‹æœ¬åœ°é¢„å¤„ç†å›¾åƒ: {input_path}")
    
    # 1. å›¾åƒè¯»å–ä¸é‡é‡‡æ ·
    ${config.enableDpi ? `image = resample_image_by_dpi(input_path)` : `image = cv2.imread(input_path)\n    if image is None: raise ValueError("è¯»å–å¤±è´¥")`}
    
    # 2. å›¾åƒå¼ºåŒ–å¤„ç†
    ${config.enableResize ? `image = resize_image_for_paddle(image)` : `# è·³è¿‡å°ºå¯¸é™åˆ¶`}
    ${config.enableDeskew ? `image = deskew_image(image)` : `# è·³è¿‡å€¾æ–œæ ¡æ­£`}
    ${config.enableMoire ? `image = remove_moire_pattern(image)` : `# è·³è¿‡å±å¹•å»å™ª`}
    ${config.enableClahe ? `image = enhance_contrast_clahe(image)` : `# è·³è¿‡å¯¹æ¯”åº¦å¢å¼º`}

    # 3. ä¿å­˜æœ€ç»ˆç»“æœä¸æ ‡ç­¾æ³¨å…¥
    image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    pil_img = Image.fromarray(image_rgb)
    ${config.enableDpi ? `pil_img.save(output_path, dpi=(${config.targetDpi}, ${config.targetDpi}))` : `pil_img.save(output_path)`}
    
    print(f"[Pipeline] é¢„å¤„ç†å®Œæˆ!å·²ä¿å­˜è‡³: {output_path}")
    return output_path

# ==========================================
# äº‘ç«¯ API è°ƒç”¨æ¨¡å— (é›†æˆå·¥ä½œæµç‰ˆ)
# ==========================================
`;
    
    if (config.apiMode === 'sync') {
        code += `def call_paddleocr_sync(file_path):
    print(f"\\n[API] æ­£åœ¨å‘é€è‡³äº‘ç«¯: {file_path}")
    with open(file_path, "rb") as file:
        file_data = base64.b64encode(file.read()).decode("ascii")

    payload = {
        "file": file_data,
        "fileType": 1,
        "useDocOrientationClassify": False,
        "useDocUnwarping": False,
        ${!isOcrV5Wf ? '"useChartRecognition": False,' : '"useTextlineOrientation": False,'}
    }
    
    response = requests.post(API_URL, json=payload, headers={
        "Authorization": f"token {TOKEN}",
        "Content-Type": "application/json"
    })
    response.raise_for_status()
    
    result = response.json().get("result", {})
    if "${resultsKeyWf}" in result:
        print(f"\\n[è§£ææˆåŠŸ] æå–åˆ° {len(result['${resultsKeyWf}'])} ä¸ªæ•°æ®å—ã€‚è¯¦ç»†è§£æè½ç›˜é€»è¾‘è¯·å‚è€ƒä¸Šæ–¹çš„ã€å®˜æ–¹ API Demoã€‘ã€‚")
    return result
`;
    } else {
        code += `def call_paddleocr_async(file_path):
    print(f"\\n[API] æ­£åœ¨æäº¤å¼‚æ­¥ä»»åŠ¡: {file_path}")
    headers = { "Authorization": f"bearer {TOKEN}" }
    
    optional_payload = {
        "useDocOrientationClassify": False,
        "useDocUnwarping": False,
        ${!isOcrV5Wf ? '"useChartRecognition": False,' : '"useTextlineOrientation": False,'}
    }
    
    with open(file_path, "rb") as f:
        res = requests.post(JOB_URL, headers=headers, data={
            "model": MODEL,
            "optionalPayload": json.dumps(optional_payload)
        }, files={"file": f})
    
    res.raise_for_status()
    jobId = res.json()["data"]["jobId"]
    print(f"[API] ä»»åŠ¡æäº¤æˆåŠŸï¼ŒJobID: {jobId}\\nå¼€å§‹è½®è¯¢...")

    while True:
        status_res = requests.get(f"{JOB_URL}/{jobId}", headers=headers)
        if status_res.status_code != 200:
            time.sleep(5)
            continue
            
        state = status_res.json()["data"]["state"]
        if state == 'done':
            jsonl_url = status_res.json()['data']['resultUrl']['jsonUrl']
            print(f"\\n[API] ä»»åŠ¡å®Œæˆï¼ç»“æœä¸‹è½½é“¾æ¥: {jsonl_url}")
            print("è¯¦ç»†çš„æ–‡ä»¶è§£æä¸è½ç›˜é€»è¾‘ï¼Œè¯·å‚è€ƒä¸Šæ–¹çš„ã€å®˜æ–¹ API Demoã€‘ã€‚")
            return jsonl_url
        elif state == "failed":
            print(f"\\n[API] ä»»åŠ¡å¤±è´¥")
            sys.exit()
        time.sleep(5)
`;
    }

    code += `
# ==========================================
# æ‰§è¡Œå…¥å£ (Main)
# ==========================================
if __name__ == "__main__":
    test_file = "test_image.jpg" # è¯·æ›¿æ¢ä¸ºå®é™…çš„æµ‹è¯•å›¾ç‰‡è·¯å¾„
    
    if os.path.exists(test_file):
        print(f"\\n{'='*50}\\nå¯åŠ¨ OCR å›¾åƒå¢å¼ºä¸è§£ææ€»å·¥ä½œæµ\\n{'='*50}")
        # 1. æ‰§è¡Œæœ¬åœ°é¢„å¤„ç†
        processed_file = preprocess_image(test_file)
        # 2. è¾“é€è‡³å¤§æ¨¡å‹
        ${config.apiMode === 'sync' ? `result = call_paddleocr_sync(processed_file)\n        print("\\nå·¥ä½œæµå½»åº•æ‰§è¡Œå®Œæ¯•ï¼")` : `call_paddleocr_async(processed_file)\n        print("\\nå·¥ä½œæµå½»åº•æ‰§è¡Œå®Œæ¯•ï¼")`}
    else:
        print(f"æ‰¾ä¸åˆ°æµ‹è¯•æ–‡ä»¶: {test_file}")
`;
    return code;
  };

  // åŠ¨æ€è®¡ç®—ç›®å‰å¯è§çš„ä»£ç  Tabs
  const visibleCodeTabs = [
    { id: 'workflow', label: 'æ€»å·¥ä½œæµè°ƒç”¨', icon: <Terminal className="w-4 h-4" /> },
    ...(config.enableDpi ? [{ id: 'dpi', label: 'DPI é‡é‡‡æ ·', icon: <ImageIcon className="w-4 h-4" /> }] : []),
    ...(config.enableResize ? [{ id: 'resize', label: 'å°ºå¯¸æˆªæ–­', icon: <Maximize className="w-4 h-4" /> }] : []),
    ...(config.enableDeskew ? [{ id: 'deskew', label: 'å€¾æ–œæ ¡æ­£', icon: <Grid className="w-4 h-4" /> }] : []),
    ...(config.enableClahe ? [{ id: 'clahe', label: 'å¯¹æ¯”åº¦å¢å¼º', icon: <SunMedium className="w-4 h-4" /> }] : []),
    ...(config.enableMoire ? [{ id: 'moire', label: 'å»æ‘©å°”çº¹', icon: <MonitorOff className="w-4 h-4" /> }] : [])
  ];

  // å½“å…³é—­æŸä¸ªå¼€å…³æ—¶ï¼Œå¦‚æœå½“å‰æ¿€æ´»çš„ tab æ­£æ˜¯é‚£ä¸ªæ¨¡å—ï¼Œåˆ‡å›å·¥ä½œæµ
  useEffect(() => {
    if (!visibleCodeTabs.find(t => t.id === activeCodeTab)) {
      setActiveCodeTab('workflow');
    }
  }, [config, activeCodeTab, visibleCodeTabs]);


  const renderCodeContent = () => {
    let rawCode = activeCodeTab === 'workflow' ? generateWorkflowCode() : codeBlocks[activeCodeTab];
    return (
      <pre className="text-[13px] text-slate-300 font-mono leading-relaxed whitespace-pre">
        <code dangerouslySetInnerHTML={{ __html: highlightPython(rawCode) }} />
      </pre>
    );
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] text-slate-800 font-sans selection:bg-blue-200">
      
      {/* ================= é¡¶æ  ================= */}
      <header className="bg-white/80 backdrop-blur-md border-b border-slate-200/60 sticky top-0 z-20 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center gap-3">
              <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-xl shadow-inner shadow-white/20">
                <BrainCircuit className="w-5 h-5 text-white" />
              </div>
              <div>
                <h1 className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-700 tracking-tight">
                  PaddleOCR å·¥å…·ç®±
                </h1>
              </div>
            </div>
            
            <div className="flex items-center gap-2 bg-slate-100/80 p-1 rounded-xl border border-slate-200/50">
              <button
                onClick={() => setActiveTab('guide')}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 ${
                  activeTab === 'guide' ? 'bg-white text-blue-600 shadow-sm ring-1 ring-slate-900/5' : 'text-slate-500 hover:text-slate-800 hover:bg-slate-200/50'
                }`}
              >
                <BookOpen className="w-4 h-4" /> æŒ‡å—
              </button>
              <button
                onClick={() => setActiveTab('generator')}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 ${
                  activeTab === 'generator' ? 'bg-white text-indigo-600 shadow-sm ring-1 ring-slate-900/5' : 'text-slate-500 hover:text-slate-800 hover:bg-slate-200/50'
                }`}
              >
                <Code2 className="w-4 h-4" /> é¢„å¤„ç†å·¥ä½œæµ
              </button>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-20">
        
        {/* ================= æ ‡ç­¾é¡µ 1: æ¨¡å‹æŒ‡å— ================= */}
        {activeTab === 'guide' && (
          <div className="space-y-8 animation-fade-in">
            <div className="text-center max-w-2xl mx-auto mb-10">
              <h2 className="text-3xl font-bold text-slate-900 tracking-tight mb-4">ç²¾å‡†é€‰å‹ï¼Œäº‹åŠåŠŸå€</h2>
              <p className="text-slate-500 text-sm leading-relaxed">
                åœ¨â€œä»»åŠ¡å¤æ‚åº¦â€ã€â€œAPIé¢„ç®—â€å’Œâ€œå“åº”å»¶è¿Ÿâ€ä¹‹é—´å¯»æ‰¾æœ€ä½³å¹³è¡¡ç‚¹ã€‚æ˜ç¡®éœ€æ±‚ï¼šæ˜¯ç®€å•æå­—ï¼Œè¿˜æ˜¯æ·±åº¦è§£æåŒ…å«è¡¨æ ¼å…¬å¼çš„å¤æ‚æ–‡æ¡£ï¼Ÿé€‰æ‹©æœ€é€‚åˆæ‚¨åœºæ™¯çš„æ¨¡å‹ã€‚
              </p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {Object.values(MODELS).map(model => (
                <div key={model.id} className={`bg-gradient-to-b ${model.bg} rounded-3xl p-6 border ${model.border} shadow-sm hover:shadow-md transition-all duration-300 relative overflow-hidden group hover:-translate-y-1`}>
                  <div className="absolute top-4 right-4 bg-white/60 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-slate-700 border border-white/40 shadow-sm">
                    {model.tag}
                  </div>
                  <div className="w-14 h-14 rounded-2xl bg-white shadow-sm flex items-center justify-center mb-5 border border-white/60">
                    {model.icon}
                  </div>
                  <h3 className="text-xl font-bold text-slate-900 mb-2">{model.name}</h3>
                  <p className="text-sm text-slate-600 min-h-[44px] leading-relaxed">{model.desc}</p>
                  
                  <div className="mt-6 space-y-5">
                    <div>
                      <p className="text-xs font-bold tracking-widest text-slate-400 uppercase mb-3 flex items-center gap-2">
                         <div className="w-3 h-px bg-slate-300"></div> æ ¸å¿ƒç‰¹æ€§
                      </p>
                      <ul className="space-y-2.5">
                        {model.features.map((feat, i) => (
                          <li key={i} className="flex items-start gap-2.5 text-sm text-slate-700 font-medium">
                            <CheckCircle2 className="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0" />
                            <span>{feat}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                    <div className="bg-white/50 rounded-xl p-4 border border-white/60 shadow-sm">
                      <p className="text-xs font-bold text-slate-500 mb-1.5 flex items-center gap-1.5">
                        <Layers className="w-3.5 h-3.5" /> é€‚ç”¨åœºæ™¯
                      </p>
                      <p className="text-xs text-slate-700 leading-relaxed font-medium">{model.useCases}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* Tokenè·å–å¼•å¯¼ */}
             <div className="mt-8 bg-blue-50/50 border border-blue-100/50 rounded-3xl p-8 flex flex-col md:flex-row items-center justify-between gap-6 overflow-hidden relative">
              <div className="absolute -right-10 -top-10 w-40 h-40 bg-blue-400/10 rounded-full blur-3xl"></div>
              <div className="relative z-10">
                <h3 className="text-lg font-bold text-slate-900 flex items-center gap-2 mb-2">
                  <Activity className="w-5 h-5 text-blue-600" /> å‡†å¤‡å¼€å§‹æ¥å…¥ï¼Ÿ
                </h3>
                <p className="text-sm text-slate-600">ä½ éœ€è¦è·å–ä¸ªäººçš„ API Token æ‰èƒ½è°ƒç”¨äº‘ç«¯å¤§æ¨¡å‹æ¥å£ã€‚</p>
              </div>
               <a 
                href="https://aistudio.baidu.com/paddleocr/task" 
                target="_blank" 
                rel="noreferrer"
                className="relative z-10 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-6 py-3 rounded-xl transition-all shadow-lg shadow-blue-600/20 flex items-center gap-2 whitespace-nowrap"
              >
                å‰å¾€ AI Studio è·å– Token <ArrowRight className="w-4 h-4" />
              </a>
            </div>
          </div>
        )}

        {/* ================= æ ‡ç­¾é¡µ 2: é¢„å¤„ç†ä»£ç ç”Ÿæˆ ================= */}
        {activeTab === 'generator' && (
          <div className="space-y-6 animation-fade-in">
            
            {/* ====== æ•°æ®å¯¹æ¯”çœ‹æ¿ ====== */}
            <div className="bg-white rounded-2xl border border-slate-200/60 shadow-sm overflow-hidden mb-8">
              <div className="bg-slate-50 border-b border-slate-200/60 px-5 py-3 flex items-center justify-between">
                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                  <Activity className="w-5 h-5 text-indigo-500" />
                  å®æˆ˜æ•ˆæœå¯¹æ¯”ï¼šä¸ºä½•éœ€è¦é¢„å¤„ç†ï¼Ÿ
                </h3>
                <span className="text-xs font-medium bg-white px-2.5 py-1 rounded-md border border-slate-200 text-slate-500">
                  æµ‹è¯•å›¾ï¼šæ‰‹æœºç¿»æ‹æ­ªæ–œé”™é¢˜å›¾
                </span>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-100">
                {/* æœªå¤„ç† */}
                <div className="p-6 relative overflow-hidden group">
                  <div className="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-bl-full -z-10 transition-transform group-hover:scale-110"></div>
                  <div className="flex items-center gap-2 mb-4">
                    <span className="flex items-center justify-center w-6 h-6 rounded-full bg-red-100 text-red-600 font-bold text-xs">X</span>
                    <h4 className="font-bold text-slate-700">åŸç”Ÿç›´ä¼  (æœªå¤„ç†)</h4>
                  </div>
                  
                  {/* --- é¢„ç•™ä½ï¼šæœªå¤„ç†å›¾ç‰‡ --- */}
                  <div className="w-full h-64 bg-slate-100/80 border border-slate-200 border-dashed rounded-xl mb-6 flex flex-col items-center justify-center text-slate-400 overflow-hidden relative group-hover:border-red-300 transition-colors">
                    <ImageIcon className="w-8 h-8 mb-2 opacity-40 group-hover:text-red-400 transition-colors" />
                    <span className="text-sm font-medium">é¢„ç•™å±•ç¤ºä½ï¼šæ­ªæ–œ/æ¨¡ç³Šçš„åŸå›¾</span>
                    <span className="text-[10px] text-slate-400 mt-1">æ›¿æ¢ä¸‹æ–¹æ³¨é‡Šä»£ç å³å¯å±•ç¤º</span>
                    {/* ğŸ’¡ å¼€å‘è€…è¯·åœ¨æ­¤å¤„å¡«å…¥å®é™…å›¾ç‰‡ï¼š
                    <img src="your-raw-image-url.jpg" alt="æœªå¤„ç†åŸå›¾" className="absolute inset-0 w-full h-full object-contain p-2 bg-slate-50" /> 
                    */}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white border border-red-100/50 p-3 rounded-xl shadow-sm">
                      <p className="text-[11px] text-slate-400 font-semibold mb-1 uppercase tracking-wider">è¾“é€åˆ†è¾¨ç‡</p>
                      <p className="text-sm font-mono font-medium text-slate-800">1389 Ã— 1239</p>
                      <p className="text-xs text-slate-400 mt-0.5">åƒç´ æ€»é‡: 172ä¸‡</p>
                    </div>
                    <div className="bg-white border border-red-100/50 p-3 rounded-xl shadow-sm">
                      <p className="text-[11px] text-slate-400 font-semibold mb-1 uppercase tracking-wider">è§£æç»“æœ</p>
                      <p className="text-sm font-mono font-medium text-slate-800">8,379 å­—ç¬¦</p>
                      <div className="mt-1 flex items-center gap-1 text-[11px] text-red-600 font-medium bg-red-50 py-0.5 px-1.5 rounded w-fit">
                        <AlertTriangle className="w-3 h-3" /> æ¨¡å‹é™·å…¥æ­»å¾ªç¯å¹»è§‰
                      </div>
                    </div>
                  </div>
                </div>

                {/* å¤„ç†å */}
                <div className="p-6 relative overflow-hidden group">
                  <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-50 rounded-bl-full -z-10 transition-transform group-hover:scale-110"></div>
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-2">
                      <span className="flex items-center justify-center w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 font-bold text-xs">âœ“</span>
                      <h4 className="font-bold text-slate-700">æ ‡å‡†é¢„å¤„ç† (æ³¨å…¥ 72 DPI)</h4>
                    </div>
                    <span className="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full font-bold border border-emerald-100">æ¨èæ–¹æ¡ˆ</span>
                  </div>

                  {/* --- é¢„ç•™ä½ï¼šå¤„ç†åå›¾ç‰‡ --- */}
                  <div className="w-full h-64 bg-emerald-50/50 border border-emerald-200 border-dashed rounded-xl mb-6 flex flex-col items-center justify-center text-emerald-600/60 overflow-hidden relative group-hover:border-emerald-400 transition-colors">
                    <ImageIcon className="w-8 h-8 mb-2 opacity-60 group-hover:text-emerald-500 transition-colors" />
                    <span className="text-sm font-medium">é¢„ç•™å±•ç¤ºä½ï¼šæ‘†æ­£å¹¶å¸¦æœ‰OCRæ£€æµ‹æ¡†çš„ç»“æœ</span>
                    <span className="text-[10px] text-emerald-600/50 mt-1">æ›¿æ¢ä¸‹æ–¹æ³¨é‡Šä»£ç å³å¯å±•ç¤º</span>
                    {/* ğŸ’¡ å¼€å‘è€…è¯·åœ¨æ­¤å¤„å¡«å…¥å®é™…å›¾ç‰‡ï¼š
                    <img src="your-processed-image-url.jpg" alt="å¤„ç†åå›¾ç‰‡" className="absolute inset-0 w-full h-full object-contain p-2 bg-white" /> 
                    */}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white border border-emerald-100/50 p-3 rounded-xl shadow-sm">
                      <p className="text-[11px] text-slate-400 font-semibold mb-1 uppercase tracking-wider">é‡é‡‡æ ·åˆ†è¾¨ç‡</p>
                      <p className="text-sm font-mono font-medium text-slate-800">1389 Ã— 1239</p>
                      <p className="text-xs text-emerald-600 mt-0.5 font-medium">æ¸…æ™°åº¦ä¿ç•™ï¼ŒDPI è§„èŒƒåŒ–</p>
                    </div>
                    <div className="bg-white border border-emerald-100/50 p-3 rounded-xl shadow-sm">
                      <p className="text-[11px] text-slate-400 font-semibold mb-1 uppercase tracking-wider">è§£æç»“æœ</p>
                      <p className="text-sm font-mono font-medium text-slate-800">3,805 å­—ç¬¦</p>
                      <div className="mt-1 flex items-center gap-1 text-[11px] text-emerald-600 font-medium bg-emerald-50 py-0.5 px-1.5 rounded w-fit">
                        <CheckCircle2 className="w-3 h-3" /> 52å—ç‰ˆé¢ç²¾å‡†è¿˜åŸ
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* ====== å®˜æ–¹åŸºç¡€ API è°ƒç”¨ Demo (ç‹¬ç«‹æ¨¡å—) ====== */}
            <div className="bg-[#0d1117] rounded-2xl shadow-xl overflow-hidden mb-8 border border-slate-800">
              <div className="bg-[#161b22] border-b border-[#30363d] px-5 py-3 flex flex-wrap items-center justify-between gap-4">
                <h3 className="font-bold text-slate-200 flex items-center gap-2">
                  <Activity className="w-5 h-5 text-blue-400" />
                  å®˜æ–¹åŸç”Ÿ API è°ƒç”¨ Demo
                </h3>
                <div className="flex flex-wrap items-center gap-3">
                  <select 
                    value={officialDemoModel}
                    onChange={(e) => setOfficialDemoModel(e.target.value)}
                    className="bg-[#21262d] text-slate-300 border border-[#30363d] rounded text-xs px-2 py-1.5 outline-none focus:border-blue-500"
                  >
                    <option value="PP-OCRv5">PP-OCRv5</option>
                    <option value="PP-StructureV3">PP-StructureV3</option>
                    <option value="PaddleOCR-VL-1.5">PaddleOCR-VL-1.5</option>
                  </select>
                  <select 
                    value={officialDemoMode}
                    onChange={(e) => setOfficialDemoMode(e.target.value)}
                    className="bg-[#21262d] text-slate-300 border border-[#30363d] rounded text-xs px-2 py-1.5 outline-none focus:border-blue-500"
                  >
                    <option value="sync">åŒæ­¥è°ƒç”¨ (Sync)</option>
                    <option value="async">å¼‚æ­¥è°ƒç”¨ (Async)</option>
                  </select>
                  <button
                    onClick={() => {
                        navigator.clipboard.writeText(getOfficialDemoCode(officialDemoModel, officialDemoMode));
                        setCopiedOfficial(true);
                        setTimeout(() => setCopiedOfficial(false), 2000);
                    }}
                    className="ml-2 flex items-center gap-1.5 text-xs font-semibold text-slate-300 hover:text-white bg-[#21262d] hover:bg-[#30363d] px-3 py-1.5 rounded border border-[#363b42] transition-colors whitespace-nowrap"
                  >
                    {copiedOfficial ? <CheckCircle2 className="w-4 h-4 text-emerald-400" /> : <Copy className="w-4 h-4" />}
                    {copiedOfficial ? 'å·²å¤åˆ¶' : 'å¤åˆ¶ä»£ç '}
                  </button>
                </div>
              </div>
              <div className="p-5 overflow-auto custom-scrollbar max-h-[400px]">
                <pre className="text-[13px] text-slate-300 font-mono leading-relaxed whitespace-pre">
                  <code dangerouslySetInnerHTML={{ __html: highlightPython(getOfficialDemoCode(officialDemoModel, officialDemoMode)) }} />
                </pre>
              </div>
            </div>

            {/* ====== å·¥ä½œæµç”Ÿæˆå™¨ä¸»ä½“ ====== */}
            <div className="flex flex-col xl:flex-row gap-6">
              
              {/* å·¦ä¾§é…ç½®é¢æ¿ */}
              <div className="xl:w-[420px] flex-shrink-0 flex flex-col gap-6">
                
                {/* åŸºç¡€è®¾å®š */}
                <div className="bg-white rounded-2xl p-5 border border-slate-200/80 shadow-sm relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                  <h3 className="font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <Settings2 className="w-5 h-5 text-indigo-500" /> åŸºç¡€é€šé“é…ç½®
                  </h3>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">é€‰æ‹©æ¨¡å‹å¼•æ“</label>
                      <div className="relative">
                        <select 
                          value={config.model}
                          onChange={(e) => setConfig({...config, model: e.target.value})}
                          className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium text-slate-800 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 outline-none appearance-none transition-all"
                        >
                          <option value="PP-OCRv5">PP-OCRv5 (è½»é‡æé€Ÿ)</option>
                          <option value="PP-StructureV3">PP-StructureV3 (ç»“æ„è¿˜åŸ)</option>
                          <option value="PaddleOCR-VL-1.5">PaddleOCR-VL-1.5 (å…¨èƒ½æ——èˆ°)</option>
                        </select>
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                          <Grid className="w-4 h-4" />
                        </div>
                      </div>
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">API é€šä¿¡æ¨¡å¼</label>
                      <div className="flex rounded-xl overflow-hidden border border-slate-200 bg-slate-50 p-1">
                        <button 
                          onClick={() => setConfig({...config, apiMode: 'sync'})}
                          className={`flex-1 text-sm py-2 rounded-lg transition-all font-medium ${config.apiMode === 'sync' ? 'bg-white shadow border border-slate-200/50 text-indigo-600' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/30'}`}
                        >
                          åŒæ­¥ (Sync)
                        </button>
                        <button 
                          onClick={() => setConfig({...config, apiMode: 'async'})}
                          className={`flex-1 text-sm py-2 rounded-lg transition-all font-medium ${config.apiMode === 'async' ? 'bg-white shadow border border-slate-200/50 text-indigo-600' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/30'}`}
                        >
                          å¼‚æ­¥ (Async)
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* ç®—æ³•ç§¯æœ¨ */}
                <div className="bg-white rounded-2xl border border-slate-200/80 shadow-sm flex-1 flex flex-col overflow-hidden relative">
                  <div className="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                  <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                    <h3 className="font-bold text-slate-900 flex items-center gap-2">
                      <FileCode2 className="w-5 h-5 text-emerald-500" /> é¢„å¤„ç†æµæ°´çº¿ç§¯æœ¨
                    </h3>
                    <span className="text-[10px] font-bold bg-slate-200 text-slate-600 px-2 py-0.5 rounded uppercase tracking-wider">OpenCV/PIL</span>
                  </div>
                  
                  <div className="p-3 space-y-2 flex-1 overflow-y-auto">
                    {/* DPI Config */}
                    <label className={`flex flex-col p-3.5 rounded-xl border transition-all cursor-pointer ${config.enableDpi ? 'bg-blue-50/30 border-blue-200 shadow-sm' : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'}`}>
                      <div className="flex items-start gap-3">
                        <input 
                          type="checkbox" 
                          checked={config.enableDpi}
                          onChange={(e) => setConfig({...config, enableDpi: e.target.checked})}
                          className="mt-0.5 w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500"
                        />
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <ImageIcon className={`w-4 h-4 ${config.enableDpi ? 'text-blue-600' : 'text-slate-400'}`} />
                            <span className={`text-sm font-bold ${config.enableDpi ? 'text-slate-900' : 'text-slate-700'}`}>ç‰©ç†é‡é‡‡æ ·ä¸ DPI æ³¨å…¥</span>
                          </div>
                          <p className="text-xs text-slate-500">ç‰©ç†çº§åƒç´ ç¼©æ”¾ï¼Œç»Ÿä¸€ç‰©ç†æ‰“å°æ ‡å‡†ï¼Œé˜²æ­¢ PDF æ’ç‰ˆé”™ä¹±ã€‚</p>
                        </div>
                      </div>
                      {config.enableDpi && (
                         <div className="mt-3 ml-7 flex items-center gap-3 bg-white p-2.5 rounded-lg border border-blue-100">
                           <span className="text-xs font-semibold text-slate-600">ç›®æ ‡é‡é‡‡æ · DPI:</span>
                           <input 
                            type="number" 
                            value={config.targetDpi}
                            onChange={(e) => setConfig({...config, targetDpi: parseInt(e.target.value) || 100})}
                            className="w-24 bg-slate-50 border border-slate-200 rounded-md px-2 py-1 text-sm font-mono outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                           />
                         </div>
                      )}
                    </label>

                    {/* Resize Config */}
                    <label className={`flex flex-col p-3.5 rounded-xl border transition-all cursor-pointer ${config.enableResize ? 'bg-blue-50/30 border-blue-200 shadow-sm' : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'}`}>
                      <div className="flex items-start gap-3">
                        <input 
                          type="checkbox" 
                          checked={config.enableResize}
                          onChange={(e) => setConfig({...config, enableResize: e.target.checked})}
                          className="mt-0.5 w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500"
                        />
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <Maximize className={`w-4 h-4 ${config.enableResize ? 'text-blue-600' : 'text-slate-400'}`} />
                            <span className={`text-sm font-bold ${config.enableResize ? 'text-slate-900' : 'text-slate-700'}`}>æé™å°ºå¯¸æˆªæ–­</span>
                          </div>
                          <p className="text-xs text-slate-500">ç¡¬æ€§é™åˆ¶æœ€å¤§è¾¹é•¿ï¼Œé˜²æ­¢ 4K å›¾æ’‘çˆ†æ˜¾å­˜ (OOM) æˆ– Token çˆ†ç‚¸ã€‚</p>
                        </div>
                      </div>
                      {config.enableResize && (
                         <div className="mt-3 ml-7 flex items-center gap-3 bg-white p-2.5 rounded-lg border border-blue-100">
                           <span className="text-xs font-semibold text-slate-600">é•¿è¾¹é˜ˆå€¼(px):</span>
                           <select 
                            value={config.maxSize}
                            onChange={(e) => setConfig({...config, maxSize: parseInt(e.target.value)})}
                            className="flex-1 bg-slate-50 border border-slate-200 rounded-md px-2 py-1 text-sm outline-none focus:border-blue-500"
                           >
                             <option value={1920}>1920 (å¤æ‚æ’ç‰ˆ/å¤šå›¾è¡¨)</option>
                             <option value={960}>960 (ç®€å•çº¯æ–‡æœ¬æ®µè½)</option>
                           </select>
                         </div>
                      )}
                    </label>

                    {/* Deskew Config */}
                    <label className={`flex items-start gap-3 p-3.5 rounded-xl border transition-all cursor-pointer ${config.enableDeskew ? 'bg-blue-50/30 border-blue-200 shadow-sm' : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'}`}>
                      <input type="checkbox" checked={config.enableDeskew} onChange={(e) => setConfig({...config, enableDeskew: e.target.checked})} className="mt-0.5 w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <Grid className={`w-4 h-4 ${config.enableDeskew ? 'text-blue-600' : 'text-slate-400'}`} />
                          <span className={`text-sm font-bold ${config.enableDeskew ? 'text-slate-900' : 'text-slate-700'}`}>è½»é‡çº§å€¾æ–œæ ¡æ­£ (Deskew)</span>
                        </div>
                        <p className="text-xs text-slate-500">è¾¹ç¼˜æ£€æµ‹+éœå¤«å˜æ¢æ‰¾ç›´çº¿ã€‚æ‘†æ­£å›¾ç‰‡ï¼Œå‡è½»äº‘ç«¯æ¨¡å‹ç”Ÿæˆå€¾æ–œåŒ…å›´ç›’çš„è®¡ç®—å‹åŠ›ã€‚</p>
                      </div>
                    </label>

                    {/* CLAHE Config */}
                    <label className={`flex items-start gap-3 p-3.5 rounded-xl border transition-all cursor-pointer ${config.enableClahe ? 'bg-blue-50/30 border-blue-200 shadow-sm' : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'}`}>
                      <input type="checkbox" checked={config.enableClahe} onChange={(e) => setConfig({...config, enableClahe: e.target.checked})} className="mt-0.5 w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <SunMedium className={`w-4 h-4 ${config.enableClahe ? 'text-blue-600' : 'text-slate-400'}`} />
                          <span className={`text-sm font-bold ${config.enableClahe ? 'text-slate-900' : 'text-slate-700'}`}>å±€éƒ¨å¯¹æ¯”åº¦å¢å¼º (CLAHE)</span>
                        </div>
                        <p className="text-xs text-slate-500">ä»…è°ƒæ•´ LAB äº®åº¦é€šé“ï¼Œå®Œç¾æ‹¯æ•‘æ‰‹æœºé˜´å½±é®æŒ¡ã€è¤ªè‰²å°ç« ç­‰æ¶åŠ£å…‰ç…§åœºæ™¯ã€‚</p>
                      </div>
                    </label>

                    {/* MoirÃ© Config */}
                    <label className={`flex items-start gap-3 p-3.5 rounded-xl border transition-all cursor-pointer ${config.enableMoire ? 'bg-blue-50/30 border-blue-200 shadow-sm' : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'}`}>
                      <input type="checkbox" checked={config.enableMoire} onChange={(e) => setConfig({...config, enableMoire: e.target.checked})} className="mt-0.5 w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <MonitorOff className={`w-4 h-4 ${config.enableMoire ? 'text-blue-600' : 'text-slate-400'}`} />
                          <span className={`text-sm font-bold ${config.enableMoire ? 'text-slate-900' : 'text-slate-700'}`}>å»é™¤å±å¹•æ‘©å°”çº¹ (å¯é€‰)</span>
                        </div>
                        <p className="text-xs text-slate-500">æ–½åŠ è½»å¾®çš„é«˜æ–¯æ¨¡ç³Šï¼Œæ‰“æ•£ç”µè„‘å±å¹•ç¿»æ‹å›¾çš„é«˜é¢‘åƒç´ ç½‘æ ¼ã€‚</p>
                      </div>
                    </label>
                  </div>
                </div>
              </div>

              {/* å³ä¾§æ™ºèƒ½ä»£ç é¢æ¿ */}
              <div className="flex-1 flex flex-col bg-[#0d1117] rounded-2xl overflow-hidden shadow-2xl border border-slate-800 xl:h-[800px]">
                
                {/* ç¼–è¾‘å™¨ Top Bar */}
                <div className="bg-[#161b22] border-b border-[#30363d] pt-2 px-2 flex items-end justify-between overflow-x-auto custom-scrollbar">
                  <div className="flex gap-1.5 flex-nowrap">
                    {visibleCodeTabs.map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setActiveCodeTab(tab.id)}
                        className={`flex items-center gap-1.5 px-3 py-2 text-[13px] font-medium rounded-t-lg transition-colors border-t border-x whitespace-nowrap ${
                          activeCodeTab === tab.id 
                            ? 'bg-[#0d1117] text-blue-400 border-[#30363d] border-b-transparent shadow-sm' 
                            : 'bg-transparent text-slate-500 border-transparent hover:text-slate-300 hover:bg-[#21262d]'
                        }`}
                        style={{ marginBottom: activeCodeTab === tab.id ? '-1px' : '0' }}
                      >
                        {tab.icon} {tab.label}
                      </button>
                    ))}
                  </div>
                  
                  <div className="pb-2 pr-2 pl-4">
                    <button
                      onClick={() => handleCopy(activeCodeTab === 'workflow' ? generateWorkflowCode() : codeBlocks[activeCodeTab])}
                      className="flex items-center gap-1.5 text-xs font-semibold text-slate-300 hover:text-white bg-[#21262d] hover:bg-[#30363d] px-3 py-1.5 rounded border border-[#363b42] transition-colors whitespace-nowrap"
                    >
                      {copied ? <CheckCircle2 className="w-4 h-4 text-emerald-400" /> : <Copy className="w-4 h-4" />}
                      {copied ? 'å·²å¤åˆ¶ç‰‡æ®µ' : 'å¤åˆ¶å½“å‰ç‰‡æ®µ'}
                    </button>
                  </div>
                </div>

                {/* ç¼–è¾‘å™¨ Content */}
                <div className="flex-1 p-5 overflow-auto custom-scrollbar bg-[#0d1117]">
                  {renderCodeContent()}
                </div>
              </div>

            </div>
          </div>
        )}
      </main>
      
      {/* æ»šåŠ¨æ¡ä¸åŠ¨ç”» */}
      <style dangerouslySetInnerHTML={{__html: `
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #30363d; 
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #484f58; 
        }
        .animation-fade-in {
          animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `}} />
    </div>
  );
}

// æå…¶è½»é‡çš„æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•é«˜äº®åŠ©æ‰‹ï¼ˆæ¨¡æ‹Ÿæš—è‰²ä¸»é¢˜é£æ ¼ï¼‰
function highlightPython(code) {
  let html = code
    .replace(/</g, '&lt;').replace(/>/g, '&gt;') // Escape HTML
    // Comments
    .replace(/(#.*)/g, '<span style="color: #8b949e; font-style: italic;">$1</span>')
    // Strings
    .replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '<span style="color: #a5d6ff;">$&</span>')
    // Triple Quotes (Docstrings)
    .replace(/("""[\s\S]*?""")/g, '<span style="color: #8b949e;">$1</span>')
    // Keywords
    .replace(/\b(def|import|from|return|if|else|elif|try|except|with|as|while|break|True|False|None)\b/g, '<span style="color: #ff7b72; font-weight: bold;">$1</span>')
    // Built-ins
    .replace(/\b(print|int|max|abs|len|enumerate)\b/g, '<span style="color: #79c0ff;">$1</span>')
    // Decorators / Method Calls implicitly
    .replace(/(\.[a-zA-Z0-9_]+)/g, '<span style="color: #d2a8ff;">$1</span>')
    // Numbers
    .replace(/\b(\d+(\.\d+)?)\b/g, '<span style="color: #79c0ff;">$1</span>')
    // Class/Function definitions
    .replace(/def\s+([a-zA-Z_]\w*)/g, 'def <span style="color: #d2a8ff; font-weight: bold;">$1</span>');
  return html;
}